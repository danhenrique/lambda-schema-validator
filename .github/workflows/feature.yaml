name: CI Build and Test

on:
    push:
      branches:
        - 'feature'
        - 'feature/**'
        - 'feature-**'
        - 'feature_**'

env:
  PYTHON_VERSION: "3.X"
  TEST_FOLDER: "another_value"
  REQUIREMENTS_PROD: "app/requirements.txt"
  REQUIREMENTS_TEST: "app/requirements-test.txt"
  GH_TOKEN: ${{ github.token }}

jobs:
    validate-lambda-code:
        runs-on: ubuntu-latest
        steps:
            - name: Check out repository
              uses: actions/checkout@v2

            - name: Read Configuration
              run: |
                pip install pyyaml
                python .github/scripts/read_config.py            

            # - name: Set output variable
            #   id: config
            #   run: |
            #     echo "PYTHON_VERSION=${{ env.PYTHON_VERSION }}" >> "$GITHUB_OUTPUT"
            #     echo "TEST_FOLDER=${{ env.TEST_FOLDER }}" >> "$GITHUB_OUTPUT"
            #     echo "REQUIREMENTS_PROD=${{ env.REQUIREMENTS_PROD }}" >> "$GITHUB_OUTPUT"
            #     echo "REQUIREMENTS_TEST=${{ env.REQUIREMENTS_TEST }}" >> "$GITHUB_OUTPUT"

            - name: Set up Python (from config)
              uses: actions/setup-python@v2
              with:
                python-version: ${{ env.PYTHON_VERSION }}

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r ${{ env.REQUIREMENTS_PROD }}

            - name: Run tests
              run: |
                pytest ${{ env.TEST_FOLDER }} --doctest-modules --junitxml=junit/test-results.xml --cov=com --cov-report=xml --cov-report=html

    validate-terraform:
        runs-on: ubuntu-latest
        steps:
            - name: Check out repository
              uses: actions/checkout@v2

            - name: Terraform FMT
              run: |
                cd infra
                terraform fmt -check

            - name: Terraform init
              run: |
                cd infra
                terraform init

            - name: Terraform validate
              run: |
                cd infra
                terraform validate

    create-pull-request:
        runs-on: ubuntu-latest
        needs: [validate-lambda-code, validate-terraform]
        steps:
            - name: Check out repository
              uses: actions/checkout@v2

            - name: Create Pull Request
              run: gh pr create --title "Auto-generated Pull Request" --body "This PR is created automatically by the CI pipeline." --base develop --head ${{ github.ref }}
